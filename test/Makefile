ifdef ComSpec
	OS = WIN
else
	UNAME = $(shell uname)
	ifeq ($(UNAME),Linux)
		OS = LINUX
	else
		ifeq ($(UNAME),Darwin)
			OS = MAC
		else
			OS = UNKNOWN
		endif
	endif
endif

# Linux
ifeq ($(OS),LINUX)
	BINEXT  =
	OBJEXT  = o
else
	# Darwin
	ifeq ($(OS),MAC)
		BINEXT  =
		OBJEXT  = o
	else
		# Windows
		ifeq ($(OS),WIN)
			BINEXT  = .exe
			OBJEXT  = obj
		else
			$(error: Unknown/unsupported OS)
		endif
	endif
endif

CC     = gcc
BINDIR = bin

# Voodoo for cleaning up dependencies generated by gcc -c -MMD -MP

# "library" source

SRC = mt64.c test.c
OBJ = $(patsubst %.c, .%.$(OBJEXT), $(SRC))
DEP = $(patsubst %.o,%.d,$(OBJ))
BIN = test$(BINEXT)

ifeq ($(OS),WIN)
	OFLAGS = -O3
	DFLAGS := $(DFLAGS) -DWIN
	RM = del /F /Q
	LDFLAGS = $(OFLAGS)
	WHICH = where
else
	OFLAGS = -O3 -flto
	RM = rm -f
	LDFLAGS = $(OFLAGS) -lm
	WHICH = which
endif

REPDEP = sed -i -e '1s,\($*\)\.o[ :]*,\1.o \.$*.d: ,' \.$*.d

WFLAGS = -Wall -Wextra -Wconversion -Wpedantic -Werror
DFLAGS = -D_POSIX_C_SOURCE=200809L -D_DEFAULT_SOURCE
IFLAGS = -I..

ifneq (,$(shell $(WHICH) gnuplot))
	DFLAGS += -DHAVE_GNUPLOT
endif

CFLAGS = $(OFLAGS) $(WFLAGS) $(DFLAGS)

.PHONY: all clean diag

all: $(BIN)

clean:
	$(RM) $(OBJ) $(DEP) $(BIN)

$(OBJ): .%.o: %.c
	$(CC) -c -MMD -MP $(CFLAGS) $(IFLAGS) $< -o $@
	@$(REPDEP)

$(BIN): $(OBJ)
	$(CC) $(OBJ) $(LDFLAGS) -o $(BIN)

-include $(DEP)

diag:
	@echo "*** SRC = " $(SRC)
	@echo "*** OBJ = " $(OBJ)
	@echo "*** DEP = " $(DEP)
	@echo "*** BIN = " $(BIN)
