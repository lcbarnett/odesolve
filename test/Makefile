ifdef ComSpec
	OS = WIN
else
	UNAME = $(shell uname)
	ifeq ($(UNAME),Linux)
		OS = LINUX
	else
		ifeq ($(UNAME),Darwin)
			OS = MAC
		else
			OS = UNKNOWN
		endif
	endif
endif

# Linux
ifeq ($(OS),LINUX)
	BINEXT  =
	OBJEXT  = o
else
	# Darwin
	ifeq ($(OS),MAC)
		BINEXT  =
		OBJEXT  = o
	else
		# Windows
		ifeq ($(OS),WIN)
			BINEXT  = .exe
			OBJEXT  = obj
		else
			$(error: Unknown/unsupported OS)
		endif
	endif
endif

CC     = gcc
BINDIR = bin

# Voodoo for cleaning up dependencies generated by gcc -c -MMD -MP

# "library" source

SRC = test.c
OBJ = $(patsubst %.c, .%.$(OBJEXT), $(SRC))
BIN = test$(BINEXT)

ifeq ($(OS),WIN)
	OFLAGS = -O3
	DFLAGS := $(DFLAGS) -DWIN
	RM = del /F /Q
	RBIN = $(subst /,\,$(BIN))
	LDFLAGS = $(OFLAGS)
	WHICH = where
else
	OFLAGS = -O3 -flto
	RM = rm -f
	RBIN = $(BIN)
	LDFLAGS = $(OFLAGS) -lm
	WHICH = which
endif

WFLAGS = -Wall -Wextra -Wconversion -Wpedantic -Werror
DFLAGS = -D_POSIX_C_SOURCE=200809L -D_DEFAULT_SOURCE
IFLAGS = -I..

ifneq (,$(shell $(WHICH) gnuplot))
	DFLAGS += -DHAVE_GNUPLOT
endif

GCCFLAGS = $(OFLAGS) $(WFLAGS) $(DFLAGS)

.PHONY: all clean

all: $(BIN)

clean:
	$(RM) $(OBJ) $(RBIN)

$(OBJ): .%.o: %.c
	$(CC) -c $(GCCFLAGS) $(IFLAGS) $< -o $@

$(BIN): $(OBJ)
	$(CC) $(LDFLAGS) $< -o $@

.test.o: test.c ../ode.h
